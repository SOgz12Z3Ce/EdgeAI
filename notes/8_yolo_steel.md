# 初探 CV——金属表面缺陷检测

第一个货真价实的 CV 项目，给出一些金属表面的图像，判断其含有哪些种类的缺陷。

## 图像处理知识

图像随处可见，但却不是简简单单的把像素排在文件里。这里记一下图像处理的事儿。

### 色彩空间

图像本身是视觉信息，或者说光学信息吧。这些视觉信息要被存储就需要建立一个视觉信息到有序数组的映射，我们管这个映射叫**色彩空间**。“空间”这个词其实是线性代数的，当然也可以想象一下有一块空间，里面的每一个点都可以被唯一地染色，而这个点的坐标就是这种颜色的数字表达。

色彩空间一般有三个维度（因为我们有三种视锥细胞，如果读者不是色盲的话），倒也不是不能有更多维度，不过那样肯定有一些维度是“线性相关”的，也就是说同一种颜色可以用不同的方法调出来。

色彩空间又不一定是三维的，除了只有一维的灰度图，一个例子是 CMYK。CMYK 一般用于印刷，印刷时的颜料是吸收光的，CMY 就是吸收三原色的颜料（青、品红、黄）。除此之外还有一个 K 表示黑色，把 CMY 全混一起当然就是黑了，不过实际印刷时这么干效果不好而且会变贵，为了工程上的好处，这个色彩空间就被设计成四维的。

上面说的“维度”实际上就是**通道**，一个通道是指存储某一维图像信息的独立数值序列。RGB 色彩空间就有 R、G、B 三个通道，分别存储红绿蓝的色彩信息。

除此之外插播一个，卷积神经网络其实也有“通道”的概念，这时候的维数表示特征，其实和色彩空间的通道意思很像。

在实践中，一个通道的取值范围和图像的编码方式有关系，不过比较常见的是八位整数 0~255，也就是一个字节，处理起来也方便。

### 图像文件

图像文件本身都是一些字节，但编码方式的不同区分了它们。尽管机器学习本身是数学的，也许不应该关心这种细节，但了解图像文件有哪些算是基本：

- `pbm` `pgm` `ppm`：平常基本见不到，但是它们最接近我们一般理解的“挨个存像素”的存储方式，所以提一下。它们几乎没有头部信息，绝大部分内容就是像素的编码。
- `jpg` `jpeg`：几年前最常见的文件格式，两种写法是一个意思，只不过早期 Windows 扩展名只许三个字符。JPEG 是有损压缩，使用 YCbCr 颜色空间，编码时会将图像分块，使用离散余弦变换（有些像离散傅里叶变换的东西）获取一些系数并保存。
- `png`：现在最常见的文件格式，无损压缩。同样会分块，使用“DEFLATE 算法”压缩。值得注意的是 `png` 支持 RGB 和 RGBA，所以 `png` 图片可以有透明度。
- `webp`：网页上见得比较多的。可有损可无损，使用 YUV 色彩空间。
- `svg`：矢量图，和上面的都不一样，其实是一个 `xml`，描述了每一个图形是怎么画出来的，所以绝对不会失真。

图像文件当然不止有这么多种，幸好到处都是 Python 库，还有个 ffmpeg 可以用。

### 图像载入

略去图像格式的细节，图像要被神经网络识别，一般需要：

1. 把图像加载为张量，形状为 `(高, 宽, 通道数)`（或者类似的，具体看实际情况）
2. 归一化（例如直接除以 255）
3. 打包成一个 batch，如形状为 `(大小, 高, 宽, 通道数)`，并行计算。

## 实操

### 报错

别的先不急，爆了一堆错：

#### CUDA Out of Memory

老生常谈，重启下试试，或者弄张新卡去。

#### 分页内存不足

虚拟内存没划够。

#### DLL 初始化例程失败

说啥的都有，版本不匹配、驱动没更新、权限不够……但是最后发现还是虚拟内存没划够。

### 结果

效果似乎不尽如人意，F1 最大也才 0.5 几，混淆矩阵看来龟裂基本没检测出来。

## 知识蒸馏

就结果来看，nano 模型肯定是不够用了。太大的模型部署不动，太小的模型能力不够，知识蒸馏就是把大模型的知识“传授”给小模型的过程。这个大模型就叫**教师模型**，小模型称为**学生模型**

知识蒸馏时会重新设计损失函数，不再完全学习标签，而是同时学习教师模型给出的结果。教师模型给出的结果不会和标签完全重合，相当于包含了额外的信息。学生模型可以拟合教师模型来“蒸馏”出教师模型的知识。

教师模型给出的标签叫**软标签**，为了强调额外的信息，可以在输出层取 softmax 前为所有值除以一个**温度系数** t，这个值大于 1，会让所有值相对更靠近，从而让标签更“软”。
